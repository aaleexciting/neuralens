<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Detector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712; /* bg-gray-950 */
        }

        #results-card {
            box-shadow: 0 0 80px rgba(147, 51, 234, 0.2); /* purple-500 glow */
        }

        .loader {
            border: 4px solid #4B5563; /* border-gray-600 */
            border-top: 4px solid #6366F1; /* border-indigo-500 */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #error-message {
            white-space: pre-wrap;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Transitions */
        .fade-enter {
            opacity: 0;
            transform: translateY(10px);
        }
        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 300ms, transform 300ms;
        }
        
        .modal-backdrop {
            transition: opacity 150ms ease-in-out;
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="min-h-screen flex flex-col items-center p-4 py-12 sm:p-8 selection:bg-purple-500/30">
        <div class="w-full max-w-2xl mx-auto">
            <header class="text-center mb-10">
                <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-indigo-500">Neuralens AI Detector</h1>
                <p class="mt-2 text-lg text-gray-400">Is your image generated by AI? Let's find out.</p>
            </header>

            <div id="upload-card" class="bg-gray-900/50 backdrop-blur-sm border border-gray-700 rounded-2xl shadow-2xl p-6 md:p-8 transition-all duration-300">
                <label for="file-input" id="drop-zone" class="relative block border-2 border-dashed border-gray-600 rounded-xl p-8 text-center cursor-pointer hover:border-indigo-500 hover:bg-gray-800/50 transition-all duration-300">
                    <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/png, image/jpeg, image/webp">
                    <div class="flex flex-col items-center justify-center text-gray-400 pointer-events-none">
                        <svg class="w-12 h-12 mb-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
                        </svg>
                        <p class="font-semibold text-gray-300">Drag & drop an image here</p>
                        <p class="text-sm">or <span class="text-indigo-400 font-medium">click to upload</span></p>
                         <p class="text-xs mt-2 text-gray-500">PNG, JPG, WEBP supported</p>
                    </div>
                </label>
                <div class="flex items-center my-6">
                    <div class="flex-grow border-t border-gray-700"></div>
                    <span class="flex-shrink mx-4 text-gray-500 text-sm font-medium">OR</span>
                    <div class="flex-grow border-t border-gray-700"></div>
                </div>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="url-input" placeholder="Paste an image URL" class="flex-grow bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200 placeholder-gray-500 transition-all">
                    <button id="analyze-url-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-md flex items-center justify-center">
                        <span id="analyze-url-btn-text">Analyze URL</span>
                        <svg id="analyze-url-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
                <div class="mt-6">
                    <p class="text-sm text-gray-500 mb-3 text-center">Don't have an image? Try an example:</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div id="sample-ai-card" class="group relative cursor-pointer overflow-hidden rounded-lg border border-gray-700 hover:border-indigo-500 transition-all duration-300">
                            <img src="https://res.cloudinary.com/ddrtdofqo/image/upload/v1757014145/adadwd_vbbv7p.jpg" alt="AI Generated Example" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                            <span class="absolute bottom-3 left-3 text-white font-semibold">AI-Generated Example</span>
                        </div>
                        <div id="sample-real-card" class="group relative cursor-pointer overflow-hidden rounded-lg border border-gray-700 hover:border-indigo-500 transition-all duration-300">
                           <img src="https://res.cloudinary.com/ddrtdofqo/image/upload/v1757014608/realcoy_eyes2h.jpg" alt="Real Photo Example" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
                           <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                           <span class="absolute bottom-3 left-3 text-white font-semibold">Real Photo Example</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="results-card" class="hidden mt-10 bg-gray-900/50 backdrop-blur-sm border border-gray-700 rounded-2xl shadow-2xl p-6 md:p-8">
                <div id="loader" class="flex flex-col items-center justify-center"><div class="loader"></div><p class="mt-4 text-gray-400 font-medium">Analyzing image...</p></div>
                <div id="error-message" class="hidden text-center text-red-400 bg-red-900/50 p-4 rounded-lg"></div>
                <div id="analysis-result" class="hidden">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                        <div class="flex items-center justify-center"><img id="preview-image" src="" alt="Analyzed image" class="rounded-lg max-h-64 object-contain shadow-lg"></div>
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-4">Analysis Result</h2>
                            <div><p class="text-5xl font-black mb-1" id="result-verdict"></p><p class="text-gray-400 mb-4" id="result-subtext"></p></div>
                            <div class="w-full bg-gray-700 rounded-full h-4"><div id="probability-bar" class="bg-gradient-to-r from-purple-500 to-indigo-500 h-4 rounded-full transition-all duration-500 ease-out"></div></div>
                            <p class="text-right text-sm mt-1 font-mono" id="probability-text"></p>
                        </div>
                    </div>

                    <div id="generator-details" class="mt-8 pt-6 border-t border-gray-700">
                        <h3 class="text-lg font-bold text-white mb-4">AI Generator Details</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4">
                            <div id="diffusion-details"></div>
                            <div id="gan-details"></div>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex flex-col sm:flex-row gap-3">
                        <button id="reset-btn" class="w-full sm:w-auto flex-grow bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300">Analyze Another</button>
                        <button id="copy-results-btn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM5 11a1 1 0 00-1 1v2a1 1 0 001 1h10a1 1 0 001-1v-2a1 1 0 00-1-1H5z" /></svg>
                            <span id="copy-btn-text">Copy</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="history-container" class="mt-10">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-300">Your Analysis History</h3>
                    <button id="clear-history-btn" class="hidden text-sm text-gray-500 hover:text-red-400 transition-colors flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        Clear All
                    </button>
                 </div>
                 <div id="history-list" class="space-y-3"></div>
                 <p id="no-history" class="text-gray-500 text-center py-8">No analyses yet.</p>
            </div>
        </div>

        <div id="use-cases-container" class="mt-24 w-full max-w-5xl mx-auto">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-indigo-500">Detect Manipulation, Deepfakes, Fraud, and More...</h2>
                <p class="mt-2 text-lg text-gray-400">Our technology helps identify a wide range of malicious AI-generated content.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Card 1: Misinformation -->
                <div class="group relative overflow-hidden rounded-xl border border-gray-700 bg-gray-900/50 p-5 shadow-lg transition-all duration-300 hover:border-indigo-500/50 hover:shadow-indigo-500/10">
                    <img src="https://sightengine.com/assets/img/genai/mis-disinformation.jpg" alt="Misinformation" class="w-full h-40 object-cover rounded-lg mb-4 transition-transform duration-300 group-hover:scale-105">
                    <span class="absolute top-3 left-3 bg-gray-900/80 text-white text-xs font-bold px-2 py-1 rounded-full border border-gray-600">MIS- & DISINFORMATION</span>
                    <p class="text-sm text-gray-400 mt-2">Spreading AI-generated misinformation and deepfakes in media.</p>
                </div>
                <!-- Card 2: Insurance Claims -->
                <div class="group relative overflow-hidden rounded-xl border border-gray-700 bg-gray-900/50 p-5 shadow-lg transition-all duration-300 hover:border-indigo-500/50 hover:shadow-indigo-500/10">
                    <img src="https://sightengine.com/assets/img/genai/fake-insurance-claim.jpg" alt="Insurance Claim" class="w-full h-40 object-cover rounded-lg mb-4 transition-transform duration-300 group-hover:scale-105">
                    <span class="absolute top-3 left-3 bg-gray-900/80 text-white text-xs font-bold px-2 py-1 rounded-full border border-gray-600">INSURANCE CLAIMS</span>
                    <p class="text-sm text-gray-400 mt-2">Creating fake insurance claims with faked images of incidents at home.</p>
                </div>
                <!-- Card 3: Fake Profiles -->
                <div class="group relative overflow-hidden rounded-xl border border-gray-700 bg-gray-900/50 p-5 shadow-lg transition-all duration-300 hover:border-indigo-500/50 hover:shadow-indigo-500/10">
                    <img src="https://sightengine.com/assets/img/genai/fake-profile.jpg" alt="Fake Profile" class="w-full h-40 object-cover rounded-lg mb-4 transition-transform duration-300 group-hover:scale-105">
                    <span class="absolute top-3 left-3 bg-gray-900/80 text-white text-xs font-bold px-2 py-1 rounded-full border border-gray-600">FAKE PROFILES</span>
                    <p class="text-sm text-gray-400 mt-2">Scamming users with fake profiles on social networks.</p>
                </div>
                <!-- Card 4: Fake IDs -->
                <div class="group relative overflow-hidden rounded-xl border border-gray-700 bg-gray-900/50 p-5 shadow-lg transition-all duration-300 hover:border-indigo-500/50 hover:shadow-indigo-500/10">
                    <img src="https://sightengine.com/assets/img/genai/fake-id.jpg" alt="Fake ID" class="w-full h-40 object-cover rounded-lg mb-4 transition-transform duration-300 group-hover:scale-105">
                    <span class="absolute top-3 left-3 bg-gray-900/80 text-white text-xs font-bold px-2 py-1 rounded-full border border-gray-600">FAKE IDS</span>
                    <p class="text-sm text-gray-400 mt-2">By-passing KYC checks with fake or spoofed identity documents and selfies.</p>
                </div>
                <!-- Card 5: Marketplace Spam -->
                <div class="group relative overflow-hidden rounded-xl border border-gray-700 bg-gray-900/50 p-5 shadow-lg transition-all duration-300 hover:border-indigo-500/50 hover:shadow-indigo-500/10">
                    <img src="https://sightengine.com/assets/img/genai/marketplace-spam.jpg" alt="Marketplace Spam" class="w-full h-40 object-cover rounded-lg mb-4 transition-transform duration-300 group-hover:scale-105">
                    <span class="absolute top-3 left-3 bg-gray-900/80 text-white text-xs font-bold px-2 py-1 rounded-full border border-gray-600">MARKETPLACE SPAM</span>
                    <p class="text-sm text-gray-400 mt-2">Spamming and flooding marketplaces with auto-generated variations of images.</p>
                </div>
                <!-- Card 6: Fake Photo Evidence -->
                <div class="group relative overflow-hidden rounded-xl border border-gray-700 bg-gray-900/50 p-5 shadow-lg transition-all duration-300 hover:border-indigo-500/50 hover:shadow-indigo-500/10">
                    <img src="https://sightengine.com/assets/img/genai/fabricated-evidence.jpg" alt="Fake Photo Evidence" class="w-full h-40 object-cover rounded-lg mb-4 transition-transform duration-300 group-hover:scale-105">
                    <span class="absolute top-3 left-3 bg-gray-900/80 text-white text-xs font-bold px-2 py-1 rounded-full border border-gray-600">FAKE PHOTO EVIDENCE</span>
                    <p class="text-sm text-gray-400 mt-2">Generating fraudulent accident reports with AI-generated images.</p>
                </div>
                <!-- Card 7: Impersonation -->
                <div class="group relative overflow-hidden rounded-xl border border-gray-700 bg-gray-900/50 p-5 shadow-lg transition-all duration-300 hover:border-indigo-500/50 hover:shadow-indigo-500/10">
                    <img src="https://sightengine.com/assets/img/genai/impersonation.jpg" alt="Impersonation" class="w-full h-40 object-cover rounded-lg mb-4 transition-transform duration-300 group-hover:scale-105">
                    <span class="absolute top-3 left-3 bg-gray-900/80 text-white text-xs font-bold px-2 py-1 rounded-full border border-gray-600">IMPERSONATION</span>
                    <p class="text-sm text-gray-400 mt-2">Misleading users by representing someone without their consent.</p>
                </div>
                <!-- Card 8: Nudification -->
                <div class="group relative overflow-hidden rounded-xl border border-gray-700 bg-gray-900/50 p-5 shadow-lg transition-all duration-300 hover:border-indigo-500/50 hover:shadow-indigo-500/10">
                    <img src="https://sightengine.com/assets/img/genai/nudification.jpg" alt="Nudification" class="w-full h-40 object-cover rounded-lg mb-4 transition-transform duration-300 group-hover:scale-105">
                    <span class="absolute top-3 left-3 bg-gray-900/80 text-white text-xs font-bold px-2 py-1 rounded-full border border-gray-600">NUDIFICATION</span>
                    <p class="text-sm text-gray-400 mt-2">Generating abusive images to harm users through impersonation or nudification.</p>
                </div>
                <!-- Card 9: Fake News -->
                <div class="group relative overflow-hidden rounded-xl border border-gray-700 bg-gray-900/50 p-5 shadow-lg transition-all duration-300 hover:border-indigo-500/50 hover:shadow-indigo-500/10">
                    <img src="https://sightengine.com/assets/img/genai/fake-news.jpg" alt="Fake News" class="w-full h-40 object-cover rounded-lg mb-4 transition-transform duration-300 group-hover:scale-105">
                    <span class="absolute top-3 left-3 bg-gray-900/80 text-white text-xs font-bold px-2 py-1 rounded-full border border-gray-600">FAKE NEWS</span>
                    <p class="text-sm text-gray-400 mt-2">Spreading fake news to harm democratic processes.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop bg-black/60 backdrop-blur-sm">
        <div class="bg-gray-800 border border-gray-700 rounded-xl shadow-lg w-full max-w-md p-6">
            <h2 class="text-lg font-bold text-white">Clear History</h2>
            <p class="text-sm text-gray-400 mt-2">Are you sure you want to delete all of your analysis history? This action cannot be undone.</p>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="cancel-clear" class="px-4 py-2 rounded-md text-sm font-medium text-gray-300 bg-gray-700 hover:bg-gray-600 transition-colors">Cancel</button>
                <button id="confirm-clear" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition-colors">Confirm & Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCTrc0DqQ5nKroOhVUqd8cJAcG_CmB6sFA",
            authDomain: "neuralens-app.firebaseapp.com",
            projectId: "neuralens-app",
            storageBucket: "neuralens-app.firebasestorage.app",
            messagingSenderId: "1028894601629",
            appId: "1:1028894601629:web:dff98249e9ed4600a67f74",
            measurementId: "G-219Y4ZZR9B"
        };
        
        const FAKE_AI_RESULT = {
            mainProb: 0.98,
            imageUrl: 'https://res.cloudinary.com/ddrtdofqo/image/upload/v1757014002/adadwd_apqkfm.jpg',
            genaiData: {
                diffusion: { midjourney: 0.98, stable_diffusion: 0.85, dall_e: 0.21, other: 0.05 },
                gan: { stylegan: 0.1, other: 0.02 }
            }
        };
        const FAKE_REAL_RESULT = {
            mainProb: 0.02,
            imageUrl: 'https://res.cloudinary.com/ddrtdofqo/image/upload/v1757014608/realcoy_eyes2h.jpg',
            genaiData: null
        };

        const dom = {
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('file-input'),
            urlInput: document.getElementById('url-input'),
            analyzeUrlBtn: document.getElementById('analyze-url-btn'),
            analyzeUrlBtnText: document.getElementById('analyze-url-btn-text'),
            analyzeUrlSpinner: document.getElementById('analyze-url-spinner'),
            resultsCard: document.getElementById('results-card'),
            loader: document.getElementById('loader'),
            errorMessage: document.getElementById('error-message'),
            analysisResult: document.getElementById('analysis-result'),
            previewImage: document.getElementById('preview-image'),
            resultVerdict: document.getElementById('result-verdict'),
            resultSubtext: document.getElementById('result-subtext'),
            probabilityBar: document.getElementById('probability-bar'),
            probabilityText: document.getElementById('probability-text'),
            resetBtn: document.getElementById('reset-btn'),
            copyResultsBtn: document.getElementById('copy-results-btn'),
            copyBtnText: document.getElementById('copy-btn-text'),
            uploadCard: document.getElementById('upload-card'),
            historyList: document.getElementById('history-list'),
            noHistory: document.getElementById('no-history'),
            clearHistoryBtn: document.getElementById('clear-history-btn'),
            confirmationModal: document.getElementById('confirmation-modal'),
            cancelClearBtn: document.getElementById('cancel-clear'),
            confirmClearBtn: document.getElementById('confirm-clear'),
            generatorDetails: document.getElementById('generator-details'),
            diffusionDetails: document.getElementById('diffusion-details'),
            ganDetails: document.getElementById('gan-details'),
            sampleAiCard: document.getElementById('sample-ai-card'),
            sampleRealCard: document.getElementById('sample-real-card'),
        };

        let lastResult = { verdict: '', probability: 0 };

        let app, db, auth, userId;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Firebase config is missing or invalid.", error);
            displayError("Application is not configured correctly. Please contact support.");
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                listenToHistory();
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Error during sign-in:", error);
                    displayError("Could not start a session. Please check your connection or browser settings.");
                }
            }
        });

        const show = el => el.classList.remove('hidden');
        const hide = el => el.classList.add('hidden');
        
        function showLoader() {
            hide(dom.uploadCard);
            show(dom.resultsCard);
            show(dom.loader);
            hide(dom.errorMessage);
            hide(dom.analysisResult);
        }

        function hideLoader() {
            hide(dom.loader);
        }

        function displayError(message) {
            show(dom.resultsCard);
            hideLoader();
            dom.errorMessage.textContent = message;
            show(dom.errorMessage);
            hide(dom.analysisResult);
        }

        dom.fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dom.dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => dom.dropZone.addEventListener(eventName, () => dom.dropZone.classList.add('border-indigo-500', 'bg-gray-800/50')));
        ['dragleave', 'drop'].forEach(eventName => dom.dropZone.addEventListener(eventName, () => dom.dropZone.classList.remove('border-indigo-500', 'bg-gray-800/50')));
        dom.dropZone.addEventListener('drop', (e) => handleFile(e.dataTransfer.files[0]));
        
        dom.analyzeUrlBtn.addEventListener('click', () => {
            const url = dom.urlInput.value.trim();
            if (isValidUrl(url)) {
                dom.analyzeUrlBtn.disabled = true;
                show(dom.analyzeUrlSpinner);
                hide(dom.analyzeUrlBtnText);
                handleUrl(url);
            } else {
                displayError("Please enter a valid image URL.");
                show(dom.resultsCard);
                show(dom.uploadCard);
            }
        });
        
        dom.resetBtn.addEventListener('click', () => {
             hide(dom.resultsCard);
             show(dom.uploadCard);
             dom.urlInput.value = '';
             dom.fileInput.value = '';
        });

        dom.clearHistoryBtn.addEventListener('click', () => show(dom.confirmationModal));
        dom.cancelClearBtn.addEventListener('click', () => hide(dom.confirmationModal));
        dom.confirmClearBtn.addEventListener('click', async () => {
            await clearHistory();
            hide(dom.confirmationModal);
        });

        dom.sampleAiCard.addEventListener('click', () => handleSampleAnalysis(FAKE_AI_RESULT));
        dom.sampleRealCard.addEventListener('click', () => handleSampleAnalysis(FAKE_REAL_RESULT));

        dom.copyResultsBtn.addEventListener('click', () => {
            const textToCopy = `Analysis Result: ${lastResult.verdict} (${Math.round(lastResult.probability * 100)}% confidence)`;
            copyToClipboard(textToCopy);
            dom.copyBtnText.textContent = 'Copied!';
            setTimeout(() => { dom.copyBtnText.textContent = 'Copy'; }, 2000);
        });
        
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

        function handleFile(file) {
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                displayError("Please upload a valid image file (PNG, JPG, WEBP).");
                return;
            }
            showLoader();
            const reader = new FileReader();
            reader.onload = e => {
                dom.previewImage.src = e.target.result;
                analyzeImage(file, null, e.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        function handleUrl(url) {
             showLoader();
             dom.previewImage.src = url;
             analyzeImage(null, url, url);
        }
        
        function handleSampleAnalysis(fakeResult) {
            showLoader();
            setTimeout(() => {
                displayResults(fakeResult.mainProb, fakeResult.genaiData, fakeResult.imageUrl);
            }, 1500);
        }

        function isValidUrl(string) {
            try { new URL(string); return true; } catch (_) { return false; }
        }

        function resetUrlButton() {
            dom.analyzeUrlBtn.disabled = false;
            hide(dom.analyzeUrlSpinner);
            show(dom.analyzeUrlBtnText);
        }

        function copyToClipboard(text) {
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
        }
        

        async function analyzeImage(file, url, previewUrl) {
            let payload = {};
            let logData = {};

            if (file) {
                try {
                    const imageData = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = (error) => reject(error);
                        reader.readAsDataURL(file);
                    });
                    payload = { imageData };
                    logData = { source: 'upload', fileName: file.name, previewUrl };
                } catch (error) {
                    displayError('Could not read the selected file.');
                    console.error('FileReader error:', error);
                    return;
                }
            } else if (url) {
                payload = { imageUrl: url };
                logData = { source: 'url', url: url, previewUrl };
            } else {
                displayError("No image source provided.");
                return;
            }

            await callNetlifyFunction(payload, previewUrl, logData);
        }

        async function callNetlifyFunction(payload, previewUrl, logData) {
            const functionUrl = '/.netlify/functions/analyze';
            const MAX_THUMBNAIL_SIZE_BYTES = 950 * 1024;

            if (previewUrl && previewUrl.length > MAX_THUMBNAIL_SIZE_BYTES) {
                 logData.previewUrl = null;
            }

            try {
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (response.ok && data.status === 'success') {
                     if (data.type && typeof data.type.ai_generated !== 'undefined') {
                        const mainProb = data.type.ai_generated;
                        const genaiData = data.genai;
                        displayResults(mainProb, genaiData, previewUrl);
                        await logAnalysisToFirestore({ ...logData, status: 'success', probability: mainProb });
                    } else {
                        let errorMessageText = "Analysis complete, but no AI detection result was returned.\nThis can happen if the image is too small or unsupported.";
                        displayError(errorMessageText);
                        await logAnalysisToFirestore({ ...logData, status: 'failure', error: 'Success but no genai data' });
                    }
                } else {
                    const errorMsg = data.error ? data.error.message : 'An unknown API error occurred.';
                    displayError(`API Error: ${errorMsg}`);
                    await logAnalysisToFirestore({ ...logData, status: 'failure', error: errorMsg });
                }
            } catch (err) {
                displayError('An unexpected error occurred. Please check your network connection.');
                await logAnalysisToFirestore({ ...logData, status: 'failure', error: err.message });
            } finally {
                resetUrlButton();
            }
        }
        
        function displayResults(mainProb, genaiData, imageUrl) {
            hideLoader();
            show(dom.analysisResult);
            dom.previewImage.src = imageUrl;

            const percentage = Math.round(mainProb * 100);
            dom.probabilityText.textContent = `${percentage}% confidence`;
            dom.probabilityBar.style.width = `${percentage}%`;

            if (mainProb > 0.8) {
                lastResult = { verdict: 'AI Generated', probability: mainProb };
            } else if (mainProb > 0.5) {
                lastResult = { verdict: 'Likely AI', probability: mainProb };
            } else if (mainProb > 0.2) {
                lastResult = { verdict: 'Possibly Human', probability: mainProb };
            } else {
                lastResult = { verdict: 'Likely Human', probability: mainProb };
            }
            
            dom.resultVerdict.textContent = lastResult.verdict;
            dom.resultVerdict.className = `text-5xl font-black mb-1 ${getVerdictColor(mainProb)}`;
            dom.resultSubtext.textContent = getVerdictSubtext(mainProb);

            if (genaiData) {
                show(dom.generatorDetails);
                renderGeneratorDetails('Diffusion', genaiData.diffusion, dom.diffusionDetails);
                renderGeneratorDetails('GAN', genaiData.gan, dom.ganDetails);
            } else {
                hide(dom.generatorDetails);
            }
        }
        
        function getVerdictColor(prob) {
            if (prob > 0.8) return "text-red-400";
            if (prob > 0.5) return "text-yellow-400";
            if (prob > 0.2) return "text-blue-400";
            return "text-green-400";
        }
        
        function getVerdictSubtext(prob) {
            if (prob > 0.8) return "Very high probability this image was created by AI.";
            if (prob > 0.5) return "Shows characteristics of AI-generated content.";
            if (prob > 0.2) return "Uncertain, but has some traits of AI involvement.";
            return "Suggests this image was not generated by AI.";
        }

        function renderGeneratorDetails(title, data, container) {
            container.innerHTML = ''; // Clear previous results
            if (!data || Object.keys(data).length === 0) return;

            const titleEl = document.createElement('h4');
            titleEl.className = "text-base font-semibold text-gray-300 mb-2";
            titleEl.textContent = title;
            container.appendChild(titleEl);

            const detailsList = document.createElement('div');
            detailsList.className = 'space-y-2';
            
            const sortedEntries = Object.entries(data).sort(([, a], [, b]) => b - a);

            for (const [key, value] of sortedEntries) {
                const percentage = Math.round(value * 100);
                const name = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                const itemEl = document.createElement('div');
                itemEl.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-400">${name}</span>
                        <span class="text-sm font-mono text-gray-300">${percentage}%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-1.5">
                        <div class="bg-indigo-500 h-1.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                `;
                detailsList.appendChild(itemEl);
            }
            container.appendChild(detailsList);
        }

        async function logAnalysisToFirestore(logData) {
            if (!userId) return;
            try {
                await addDoc(collection(db, `artifacts/neuralens-app/users/${userId}/analysis_history`), { ...logData, timestamp: new Date() });
            } catch (e) { console.error("Error adding document to Firestore: ", e); }
        }

        function listenToHistory() {
            if (!userId) return;
            const q = query(collection(db, `artifacts/neuralens-app/users/${userId}/analysis_history`));
            onSnapshot(q, (snapshot) => {
                const history = [];
                snapshot.forEach((doc) => history.push({ id: doc.id, ...doc.data() }));
                history.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                renderHistory(history);
            });
        }
        
        async function clearHistory() {
            if (!userId) return;
            const historyCollection = collection(db, `artifacts/neuralens-app/users/${userId}/analysis_history`);
            const snapshot = await getDocs(historyCollection);
            const batch = writeBatch(db);
            snapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
        }

        function renderHistory(history) {
            if (history.length === 0) {
                show(dom.noHistory);
                hide(dom.clearHistoryBtn);
                dom.historyList.innerHTML = '';
                return;
            }
            show(dom.clearHistoryBtn);
            hide(dom.noHistory);
            dom.historyList.innerHTML = '';
            
            history.slice(0, 10).forEach(item => {
                let badgeClass, badgeText;
                if(item.status === 'success') {
                    const prob = item.probability;
                    if (prob > 0.8) { badgeClass = 'bg-red-500/20 text-red-300'; badgeText = 'AI Generated'; }
                    else if (prob > 0.5) { badgeClass = 'bg-yellow-500/20 text-yellow-300'; badgeText = 'Likely AI'; }
                    else if (prob > 0.2) { badgeClass = 'bg-blue-500/20 text-blue-300'; badgeText = 'Possibly Human'; }
                    else { badgeClass = 'bg-green-500/20 text-green-300'; badgeText = 'Likely Human'; }
                } else {
                    badgeClass = 'bg-gray-500/20 text-gray-300';
                    badgeText = 'Failed';
                }

                let name = item.fileName || (item.url ? new URL(item.url).hostname : 'Analysis');
                if (name.length > 25) name = name.substring(0, 22) + '...';
                
                const date = item.timestamp.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                const thumbnailHTML = item.previewUrl
                    ? `<img src="${item.previewUrl}" alt="History thumbnail" class="w-12 h-12 rounded-md object-cover flex-shrink-0 bg-gray-700">`
                    : `<div class="w-12 h-12 rounded-md flex-shrink-0 bg-gray-700 flex items-center justify-center">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                               <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                           </svg>
                       </div>`;

                const div = document.createElement('div');
                div.className = 'bg-gray-800/50 border border-gray-700 p-3 rounded-lg flex items-center gap-4 fade-enter';
                div.innerHTML = `
                    ${thumbnailHTML}
                    <div class="flex-grow overflow-hidden">
                        <p class="truncate font-medium text-gray-200" title="${item.fileName || item.url}">${name}</p>
                        <p class="text-xs text-gray-400">${date}</p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        ${item.status === 'success' ? `<p class="font-semibold text-lg text-white">${Math.round(item.probability * 100)}%</p>` : ''}
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${badgeClass}">${badgeText}</span>
                    </div>
                `;
                dom.historyList.appendChild(div);
                requestAnimationFrame(() => div.classList.add('fade-enter-active'));
            });
        }
    </script>
</body>
</html>
